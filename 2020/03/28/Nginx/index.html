<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Nginx | 惑</title><meta name="description" content="Nginx"><meta name="keywords" content="Nginx"><meta name="author" content="惑"><meta name="copyright" content="惑"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon2.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Nginx"><meta name="twitter:description" content="Nginx"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/huohuohuohuohuohuo/figurebed/cover/%E7%83%AD%E7%88%B1%E5%AD%A6%E4%B9%A04.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Nginx"><meta property="og:url" content="https://huohuohuohuohuohuo.github.io/2020/03/28/Nginx/"><meta property="og:site_name" content="惑"><meta property="og:description" content="Nginx"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/huohuohuohuohuohuo/figurebed/cover/%E7%83%AD%E7%88%B1%E5%AD%A6%E4%B9%A04.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://huohuohuohuohuohuo.github.io/2020/03/28/Nginx/"><link rel="prev" title="SpringCloud" href="https://huohuohuohuohuohuo.github.io/2020/03/31/SpringCloud/"><link rel="next" title="SpringBoot" href="https://huohuohuohuohuohuo.github.io/2020/03/26/SpringBoot/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://huohuohuohuohuohuo.github.io/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: true
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">14</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">12</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">18</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li><li><a class="site-page" href="/photo/"><i class="fa-fw fa fa-camera"></i><span> Photo</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx简介"><span class="toc-number">1.</span> <span class="toc-text">nginx简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#笔记大纲"><span class="toc-number">2.</span> <span class="toc-text">笔记大纲</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#什么是nginx"><span class="toc-number">3.</span> <span class="toc-text">什么是nginx</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#代理"><span class="toc-number">4.</span> <span class="toc-text">代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#正向代理"><span class="toc-number">4.1.</span> <span class="toc-text">正向代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#反向代理"><span class="toc-number">4.2.</span> <span class="toc-text">反向代理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#负载均衡"><span class="toc-number">5.</span> <span class="toc-text">负载均衡</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#动静分离"><span class="toc-number">6.</span> <span class="toc-text">动静分离</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#安装"><span class="toc-number">7.</span> <span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx-conf-配置文件"><span class="toc-number">7.1.</span> <span class="toc-text">nginx.conf 配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#第一部分：全局块"><span class="toc-number">7.1.1.</span> <span class="toc-text">第一部分：全局块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第二部分：events块"><span class="toc-number">7.1.2.</span> <span class="toc-text">第二部分：events块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第三部分：http块"><span class="toc-number">7.1.3.</span> <span class="toc-text">第三部分：http块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#http全局块"><span class="toc-number">7.1.3.1.</span> <span class="toc-text">http全局块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#server-块"><span class="toc-number">7.1.3.2.</span> <span class="toc-text">server 块</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#全局server块"><span class="toc-number">7.1.3.2.1.</span> <span class="toc-text">全局server块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#location-块"><span class="toc-number">7.1.3.2.2.</span> <span class="toc-text">location 块</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx配置实例"><span class="toc-number">8.</span> <span class="toc-text">nginx配置实例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#反向代理1"><span class="toc-number">8.1.</span> <span class="toc-text">反向代理1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#反向代理2"><span class="toc-number">8.2.</span> <span class="toc-text">反向代理2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#location-指令说明"><span class="toc-number">8.3.</span> <span class="toc-text">location 指令说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#负载均衡-1"><span class="toc-number">8.4.</span> <span class="toc-text">负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#负载均衡策略"><span class="toc-number">8.4.1.</span> <span class="toc-text">负载均衡策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#轮询-（默认）"><span class="toc-number">8.4.1.1.</span> <span class="toc-text">轮询 （默认）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#weight"><span class="toc-number">8.4.1.2.</span> <span class="toc-text">weight</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ip-hash"><span class="toc-number">8.4.1.3.</span> <span class="toc-text">ip_hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fair（第三方）"><span class="toc-number">8.4.1.4.</span> <span class="toc-text">fair（第三方）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动静分离-1"><span class="toc-number">8.5.</span> <span class="toc-text">动静分离</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#高可用集群"><span class="toc-number">8.6.</span> <span class="toc-text">高可用集群</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx-原理"><span class="toc-number">9.</span> <span class="toc-text">nginx 原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一个master-和-多个-worker-的好处"><span class="toc-number">9.1.</span> <span class="toc-text">一个master 和 多个 worker 的好处</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#需要设置多少个worker"><span class="toc-number">9.2.</span> <span class="toc-text">需要设置多少个worker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#连接数-worker-connection"><span class="toc-number">9.3.</span> <span class="toc-text">连接数 worker_connection</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div id="web_bg" data-type="photo"></div><div class="post-bg" id="nav" style="background-image: url(https://cdn.jsdelivr.net/gh/huohuohuohuohuohuo/figurebed/cover/%E7%83%AD%E7%88%B1%E5%AD%A6%E4%B9%A04.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">惑</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li><li><a class="site-page" href="/photo/"><i class="fa-fw fa fa-camera"></i><span> Photo</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Nginx</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-03-28 17:18:51"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-03-28</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-04-16 10:03:13"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-04-16</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%9C%8D%E5%8A%A1%E4%B8%AD%E9%97%B4%E4%BB%B6/">服务中间件</a><i class="fa fa-angle-right post-meta__separator" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%9C%8D%E5%8A%A1%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/">Nginx</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">4.2k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 14 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/2020/03/28/Nginx/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2020/03/28/Nginx/" itemprop="commentCount"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1 id="nginx简介"><a href="#nginx简介" class="headerlink" title="nginx简介"></a>nginx简介</h1><blockquote>
<p><em>Nginx</em> (engine x) 是一个高性能的<a href="https://baike.baidu.com/item/HTTP" target="_blank" rel="noopener">HTTP</a>和<a href="https://baike.baidu.com/item/反向代理/7793488" target="_blank" rel="noopener">反向代理</a>web服务器，同时也提供IMAP/POP3/SMTP<a href="https://baike.baidu.com/item/服务/100571" target="_blank" rel="noopener">服务</a>。Nginx是由伊戈尔·赛索耶夫为<a href="https://baike.baidu.com/item/俄罗斯/125568" target="_blank" rel="noopener">俄罗斯</a>访问量第二的Rambler.ru站点（俄文：Рамблер）开发的，第一个公开版本0.1.0发布于2004年10月4日。</p>
<p>其将<a href="https://baike.baidu.com/item/源代码" target="_blank" rel="noopener">源代码</a>以类BSD许可证的形式发布，因它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而<a href="https://baike.baidu.com/item/闻名/2303308" target="_blank" rel="noopener">闻名</a>。2011年6月1日，nginx 1.0.4发布。</p>
<p>Nginx是一款<a href="https://baike.baidu.com/item/轻量级/10002835" target="_blank" rel="noopener">轻量级</a>的<a href="https://baike.baidu.com/item/Web/150564" target="_blank" rel="noopener">Web</a> 服务器/<a href="https://baike.baidu.com/item/反向代理/7793488" target="_blank" rel="noopener">反向代理</a>服务器及<a href="https://baike.baidu.com/item/电子邮件/111106" target="_blank" rel="noopener">电子邮件</a>（IMAP/POP3）代理服务器，在BSD-like 协议下发行。其特点是占有内存少，<a href="https://baike.baidu.com/item/并发/11024806" target="_blank" rel="noopener">并发</a>能力强，事实上nginx的并发能力在同类型的网页服务器中表现较好，中国大陆使用nginx网站用户有：百度、<a href="https://baike.baidu.com/item/京东/210931" target="_blank" rel="noopener">京东</a>、<a href="https://baike.baidu.com/item/新浪/125692" target="_blank" rel="noopener">新浪</a>、<a href="https://baike.baidu.com/item/网易/185754" target="_blank" rel="noopener">网易</a>、<a href="https://baike.baidu.com/item/腾讯/112204" target="_blank" rel="noopener">腾讯</a>、<a href="https://baike.baidu.com/item/淘宝/145661" target="_blank" rel="noopener">淘宝</a>等。</p>
</blockquote>
<a id="more"></a>

<h1 id="笔记大纲"><a href="#笔记大纲" class="headerlink" title="笔记大纲"></a>笔记大纲</h1><p>1、nginx基本概念</p>
<ul>
<li><a href="#什么是nginx">nginx 是什么，做什么事情</a></li>
<li><a href="#反向代理">方向代理</a></li>
<li><a href="#负载均衡">负载均衡</a></li>
<li><a href="#动静分离">动静分离</a></li>
</ul>
<p>2、nginx安装、配置文件</p>
<ul>
<li><a href="#安装">在linux 系统中安装 nginx</a></li>
<li>[nginx 配置文件](#nginx.conf 配置文件)</li>
</ul>
<p>3、<a href="#反向代理1">nginx 配置实例 1-反向代理</a></p>
<p>4、[nginx 配置实例 2-负载均衡](# 负载均衡)</p>
<p>5、nginx 配置实例 3-动静分离</p>
<p>6、nginx 配置高可用集群</p>
<p>7、nginx 原理</p>
<h1 id="什么是nginx"><a href="#什么是nginx" class="headerlink" title="什么是nginx"></a>什么是nginx</h1><blockquote>
<p>Nginx (“engine x”)是一个高性能的HTTP和反向代理服务器特点是占有内存少，并发能力强，事实上nginx的并发能力确实在同类型的网页服务器中表现较好，Nginx专为性能优化而开发，性能是其最重要的考量，实现上非常注重效率，能经受高负载的考验，有报告表明能支持高达50, 000个并发连接数。</p>
</blockquote>
<h1 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h1><h2 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h2><blockquote>
<p>Nginx不仅可以做反向代理，实现负载均衡。还能用作正向代理来进行上网等功能。</p>
<p>正向代理: 如果把局域网外的Intermet想象成一个巨大的资源库， 则局域网中的客户端要访</p>
<p>问Internet,则需要通过代理服务器来访问，这种代理服务就称为正向代理。</p>
</blockquote>
<p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200328224318.png"  alt></p>
<h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><blockquote>
<p>反向代理，其实客户端对代理是无感知的，因为客户端不需要任何配置就可以访问，我们只需要将请求发送到反向代理服务器，由反向代理服务器去选择目标服务器获取数据后，在返回给客户端，此时反向代理服务器和目标服务器对外就是一个服务器，暴露的是代理服务器地址，隐藏了真实服务器IP地址。</p>
</blockquote>
<p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200328225035.png"  alt></p>
<h1 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h1><blockquote>
<p>客户端发送多个请求到服务器，服务器处理请求，有一些可能要与数据库进行交互，服务器处理完毕后，再将结果返回给客户端</p>
<p>这种架构模式对于早期的系统相对单一, 并发请求相对较少的情况下是比较适合的，成本也低。但是随着信息数量的不断增长，访问量和数据量的飞速增长，以及系统业务的复杂度增加，这种架构会造成服务器相应客户端的请求日益缓慢，并发量特别大的时候，<span style="color:red">还容易造成服务器直接崩溃</span>。很明显这是由于服务器性能的瓶颈造成的问题，那么如何解决这种情况呢 ?</p>
<p>我们首先想到的可能是升级服务器的配置，比如提高CPU执行频率,加大内存等提高机器的物理性能来解决此问题，但是我们知道摩尔定律的日益失效，硬件的性能提升已经不能满足日益提升的需求了。最明显的一个例子，天猫双十一当天，某个热销商品的瞬时访问量是极其庞大的，那么类似，上面的系统架构，将机器都增加到现有的顶级物理配置，都是不能够满足需求的。那么怎么办呢 ?</p>
<p>上面的分析我们去掉了增加服务器物理配置来解决问题的办法，也就是说纵向解决问题的办法行不通了，那么横向增加服务器的数量呢?这时候集群的概念产生了，<span style="color:red">单个服务器解决不了，我们增加服务器的数量，然后将请求分发到各个服务器上，将原先请求集中到单个服务器上的情况改为将请求分发到多个服务器上，将负载分发到不同的服务器，也就是我们<br>所说的负载均衡</span></p>
</blockquote>
<p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200329104207.png"  alt></p>
<h1 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h1><blockquote>
<p>为了加快网站的解析速度，可以把动态页面和静态页面由不同的服务器来解析，加快解析度。降低原来单个服务器的压力。</p>
<p>Nginx动静分离简单来说就是把动态跟静态请求分开,不能理解成只是单纯的把动态页面和静态页面物理分离。严格意义上说应该是动态请求跟静态请求分开，可以理解成使用Nginx处理静态页面，Tomeat处理动态页面。动静分离从目前实现角度来讲大致分为两种。</p>
<p>一种是纯粹把静态文件独立成单独的城名,放在独立的服务器上,也是目前主流推崇的方案:</p>
<p>另外一种方法就是动态跟静态文件混合在一起发布，通过nginx来分开。</p>
<p>通过location指定不同的后綴名实现不同的请求转发。通过expires参数设置，可以使浏览器缓存过期时间，减少与服务器之前的请求和流量，具体Expires定义: 是给-一个资源设定一个过期时间，也就是说无需去服务端验证,直接通过浏览器自身确认是否过期即可，所以不会产生额外的流量。此种方法非常适合不经常变动的资源。(如果 经常更新的文件，不建议使用Expires 来缓存)，我这里设置3d,表示在这3天之内访问这个URL,发送一个请求，比对服务器该文件最后更新时间没有变化，则不会从服务器抓取，返回状态码304，如果有修改，则直接从服务器重新下载，返回状态码200</p>
</blockquote>
<p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200329105000.png"  alt></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p><a href="https://www.cnblogs.com/niceyoo/p/11546370.html" target="_blank" rel="noopener">https://www.cnblogs.com/niceyoo/p/11546370.html</a></p>
<p>使用Docker安装nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nginx</span><br></pre></td></tr></table></figure>

<p>创建nginx容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d --name mynginx -p 9999:9999 -v &#x2F;home&#x2F;nginx&#x2F;conf&#x2F;nginx.conf:&#x2F;etc&#x2F;nginx&#x2F;nginx.conf -v &#x2F;home&#x2F;nginx&#x2F;www:&#x2F;home&#x2F;nginx&#x2F;www -v &#x2F;home&#x2F;nginx&#x2F;static:&#x2F;home&#x2F;nginx&#x2F;static --privileged --net&#x3D;host nginx</span><br></pre></td></tr></table></figure>

<p>编写nginx.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application&#x2F;octet-stream;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        # Vue路由模式为history需添加的配置</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            if (!-e $request_filename) &#123;</span><br><span class="line">                rewrite ^(.*)$ &#x2F;index.html?s&#x3D;$1 last;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            root   &#x2F;home&#x2F;nginx&#x2F;www;</span><br><span class="line">            index  index.html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # 获取真实IP以及Websocket需添加的配置</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line"></span><br><span class="line">        # 客户端Body大小限制（文件上传大小限制配置）</span><br><span class="line">        client_max_body_size 5m;</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504 404  &#x2F;50x.html;</span><br><span class="line">        location &#x3D; &#x2F;50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    upstream mytomcat &#123;</span><br><span class="line">		server localhost:8080;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">        server &#123;</span><br><span class="line">            listen       80;</span><br><span class="line">            server_name  duxiutomcat.com;</span><br><span class="line"></span><br><span class="line">            proxy_set_header X-Forwarded-Host $host;</span><br><span class="line">            proxy_set_header X-Forwarded-Server $host;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">            location &#x2F; &#123;</span><br><span class="line">                proxy_pass http:&#x2F;&#x2F;mytomcat;  # 转发路径</span><br><span class="line">                proxy_connect_timeout 600;</span><br><span class="line">                proxy_read_timeout 600;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="nginx-conf-配置文件"><a href="#nginx-conf-配置文件" class="headerlink" title="nginx.conf 配置文件"></a>nginx.conf 配置文件</h2><h3 id="第一部分：全局块"><a href="#第一部分：全局块" class="headerlink" title="第一部分：全局块"></a>第一部分：全局块</h3><blockquote>
<p>从配置文件开始到 events 块之间的内容,主要会设置一些影响 nginx服务器整体运行的配置指令,主要包括配置运行Nginx服务器的用户(组)、允许生成的worker process数,进程PID存放路径、日志存放路径和类型以及配置文件的引入等</p>
</blockquote>
<p>比如上面的第一行配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  1;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这是Nginx服务器并发处理服务的关键配置, <span style="color:red">worker processes值越大,可以支持的并发处理量也越多</span>,但是会受到硬件，软件等设备的限制</p>
</blockquote>
<h3 id="第二部分：events块"><a href="#第二部分：events块" class="headerlink" title="第二部分：events块"></a>第二部分：events块</h3><blockquote>
<p>events 块涉及的指令主要影响 Nginx服务器与用户的网络连接。常用的设置包括是否开启对多work process 下的网络连接进行序列化, 是否允许同时接收多个网络连接,选取哪种事件驱动模型来处理连接请求，每个word process可以同时支持的最大连接数等。</p>
<p>下述例子就表示每个 work process 支持的最大连接数为1024.0<br>这部分的配置对Nginx的性能影响较大, 在实际中应该灵活配置</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="第三部分：http块"><a href="#第三部分：http块" class="headerlink" title="第三部分：http块"></a>第三部分：http块</h3><blockquote>
<p>这算是Nginx 服务器配置中最烦繁的部分, 代理，缓存和日志定义等绝大多数功能和第三方模块的配置都在这里</p>
<p>需要注意的是:  http块也可以包括http 全局块、server 块。</p>
</blockquote>
<h4 id="http全局块"><a href="#http全局块" class="headerlink" title="http全局块"></a>http全局块</h4><blockquote>
<p>http全局块配置的指令包括文件引入、MIME-TYPE 定义、日志自定义，连接超时时间，单链接请求数上限等</p>
</blockquote>
<h4 id="server-块"><a href="#server-块" class="headerlink" title="server 块"></a>server 块</h4><blockquote>
<p>这块和虚拟主机有密切关系,虚拟主机从用户角度看,和一台独立的硬件主机是完全一样的，该技术的产生是为了节省互联网服务器硬件成本</p>
<p>每个http块可以包括多个server块，而每个server块就相当于一个虚拟主机<br>而每个server块也分为全局server 块,以及可以同时包含多个location块</p>
</blockquote>
<h5 id="全局server块"><a href="#全局server块" class="headerlink" title="全局server块"></a>全局server块</h5><blockquote>
<p>最常见的配置是本虚拟机主机的监听配置和本虚拟主机的名称或IP配置。</p>
</blockquote>
<h5 id="location-块"><a href="#location-块" class="headerlink" title="location 块"></a>location 块</h5><blockquote>
<p>一个server 块可以配置多个location 块。</p>
<p>这块的主要作用是基于Nginx服务器接收到的请求字符串(例如server, name/url-string) , 对虚拟主机名称(也可以是IP别名)之外的字符串(例如前面的/uristring )进行匹配,对特定的请求进行理。地址定向、数据缓存和应答控制等功船,还有许多第三方模块的配置也在这里进行。</p>
</blockquote>
<h1 id="nginx配置实例"><a href="#nginx配置实例" class="headerlink" title="nginx配置实例"></a>nginx配置实例</h1><h2 id="反向代理1"><a href="#反向代理1" class="headerlink" title="反向代理1"></a>反向代理1</h2><p>使用tomcat演示配置反向代理</p>
<p>1、修改nginx.conf, 添加下面的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">upstream mytomcat &#123;</span><br><span class="line">		server localhost:8080;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  duxiutomcat.com;</span><br><span class="line"></span><br><span class="line">        proxy_set_header X-Forwarded-Host $host;</span><br><span class="line">        proxy_set_header X-Forwarded-Server $host;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">			proxy_pass http:&#x2F;&#x2F;mytomcat;  # 转发路径</span><br><span class="line">			proxy_connect_timeout 600;</span><br><span class="line">			proxy_read_timeout 600;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>2、保存，重启nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start 容器ID</span><br></pre></td></tr></table></figure>

<p>3、访问</p>
<p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200329153746.png"  alt></p>
<p>想让windows也能访问，修改 C:\Windows\System32\drivers\etc 下的 host 文件</p>
<p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200329154036.png"  alt></p>
<p>虚拟机IP地址加 配置文件 里 server_name 对应的 域名</p>
<p>保存，访问</p>
<p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200329154220.png"  alt></p>
<p>欧啦</p>
<h2 id="反向代理2"><a href="#反向代理2" class="headerlink" title="反向代理2"></a>反向代理2</h2><p>要求</p>
<blockquote>
<p>当 访问 192.168.156.128:9001/8080/index.html 显示 8080 的 欢迎语句</p>
<p>当 访问 192.168.156.128:9001/8081/index.html 显示 8081 的 欢迎语句</p>
</blockquote>
<p>再运行一个tomcat容器指定8081端口，nginx.conf添加 如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       9001;</span><br><span class="line">        server_name  192.168.156.128;</span><br><span class="line"></span><br><span class="line">        proxy_set_header X-Forwarded-Host $host;</span><br><span class="line">        proxy_set_header X-Forwarded-Server $host;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        </span><br><span class="line">		location ~ &#x2F;8080&#x2F; &#123;</span><br><span class="line">        	proxy_pass http:&#x2F;&#x2F;localhost:8080;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		location ~ &#x2F;8081&#x2F; &#123;</span><br><span class="line">        	proxy_pass http:&#x2F;&#x2F;localhost:8081;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启 nginx ，tomcat1，tomcat2 容器</p>
<p>效果</p>
<p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200329170208.png"  alt></p>
<p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200329170220.png"  alt></p>
<h2 id="location-指令说明"><a href="#location-指令说明" class="headerlink" title="location 指令说明"></a>location 指令说明</h2><blockquote>
<p>该指令用于匹配 URL</p>
<p>语法如下：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location [ &#x3D; | ~ | ~* | ^~] uri&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>=      用于不含正则表达式的uri前，要求请求字符串与uri严格匹配，如果匹配成功，就停止继续向下搜索并立即处理该请求</p>
<p>~      用于表示uri包含正则表达式，井且区分大小写</p>
<p><del>*    用于表示uri包含正则表达式，并且不区分大小写<br>^</del>    用于不含正则表达式的uri 前，要求Nginx服务器找到标识uri和请求字符串匹配度最高的location 后，立即使用此location处理请求，而不再使用location块中的正则uri和请求字符串做匹配</p>
<p>注意: 如果uri包含正则表达式，则必须要有~或者 ~* 标识</p>
</blockquote>
<h2 id="负载均衡-1"><a href="#负载均衡-1" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>分别给两个tomcat的webapp下创建相同的目录loadbalancing给目录下创建html文件loadbalancing</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">upstream myserver &#123;</span><br><span class="line">	server 192.168.156.128:8080;</span><br><span class="line">	server 192.168.156.128:8081;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  myloadbalancing.com;</span><br><span class="line"></span><br><span class="line">        proxy_set_header X-Forwarded-Host $host;</span><br><span class="line">        proxy_set_header X-Forwarded-Server $host;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">			proxy_pass http:&#x2F;&#x2F;myserver;  # 转发路径</span><br><span class="line">			proxy_connect_timeout 600;</span><br><span class="line">			proxy_read_timeout 600;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启 nginx ，tomcat1，tomcat2 容器，windows配置host </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.156.128 myloadbalancing.com</span><br></pre></td></tr></table></figure>

<p>效果</p>
<p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200329180419.png"  alt></p>
<p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200329180428.png"  alt></p>
<p>成功</p>
<blockquote>
<p>随着互联网信息的爆炸性增长，负载均衡(load balance)已经不再是一个很陌生的话题，顾名思义，负載均衡即是将负载分摊到不同的服务单元，既保证服务的可用性，又保证响应足够快，给用户很好的体验，快速增长的访问量和数据流量催生了各式各样的负载均衡产品，很多专业的负载均衡硬件提供了很好的功能,但却价格不非,这使得负戴均衡软件大受欢迎，nginx就是其中的一个，在linux下有Nginx、LVS、 Haproxy等等服务可以提供负载均衡服务，而且Nginx提供了几种分配方式(策略)</p>
</blockquote>
<h3 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h3><h4 id="轮询-（默认）"><a href="#轮询-（默认）" class="headerlink" title="轮询 （默认）"></a>轮询 （默认）</h4><blockquote>
<p>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除</p>
</blockquote>
<h4 id="weight"><a href="#weight" class="headerlink" title="weight"></a>weight</h4><blockquote>
<p>weight代表权,重默认为1,权重越高被分配的客户端越多，</p>
<p>指定轮询几率，weight 和访问比率成正比，用于后端服务器性能不均的情况。例如</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream myserver &#123;</span><br><span class="line">	server 192.168.156.128:8080 weight&#x3D;10;</span><br><span class="line">	server 192.168.156.128:8081 weight&#x3D;5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a>ip_hash</h4><blockquote>
<p>每个请求按访问 ip 的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。例如：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream myserver &#123;</span><br><span class="line">ip_hash</span><br><span class="line">	server 192.168.156.128:8080;</span><br><span class="line">	server 192.168.156.128:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="fair（第三方）"><a href="#fair（第三方）" class="headerlink" title="fair（第三方）"></a>fair（第三方）</h4><blockquote>
<p>按后端服务器的响应时间来分配请求，响应时间短的优先分配</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream myserver &#123;</span><br><span class="line">	server 192.168.156.128:8080;</span><br><span class="line">	server 192.168.156.128:8081;</span><br><span class="line">	fair</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="动静分离-1"><a href="#动静分离-1" class="headerlink" title="动静分离"></a>动静分离</h2><p>使用docker 创建 nginx 容器 时需要挂载一个目录，用于存放静态资源，如果没有就得重新 创建一个容器，或者更改配置文件<a href="https://blog.csdn.net/zedelei/article/details/90208183" target="_blank" rel="noopener">https://blog.csdn.net/zedelei/article/details/90208183</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d --name mynginx -p 9999:9999 -v &#x2F;home&#x2F;nginx&#x2F;conf&#x2F;nginx.conf:&#x2F;etc&#x2F;nginx&#x2F;nginx.conf -v &#x2F;home&#x2F;nginx&#x2F;www:&#x2F;home&#x2F;nginx&#x2F;www -v &#x2F;home&#x2F;nginx&#x2F;static:&#x2F;home&#x2F;nginx&#x2F;static --privileged --net&#x3D;host nginx</span><br></pre></td></tr></table></figure>

<p>从虚拟机 进入到 挂载得 static 文件目录，放入 资源</p>
<p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200330091517.png"  alt></p>
<p>修改 nginx.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">![QQ图片20200330094023](Nginx&#x2F;QQ图片20200330094023.png)server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        location ~\.(gif|jpg|jpeg|png|bmp|swf|css|js)$ &#123;</span><br><span class="line">        	root &#x2F;home&#x2F;nginx&#x2F;static&#x2F;image;</span><br><span class="line">    	&#125;</span><br><span class="line"></span><br><span class="line">        # 获取真实IP以及Websocket需添加的配置</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line"></span><br><span class="line">        # 客户端Body大小限制（文件上传大小限制配置）</span><br><span class="line">        client_max_body_size 5m;</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504 404  &#x2F;50x.html;</span><br><span class="line">        location &#x3D; &#x2F;50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>重启 nginx 容器，查看效果</p>
<p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200330091836.png"  alt></p>
<p>完成，可以根据不同文件创建不同文件夹和不同location进行区分</p>
<h2 id="高可用集群"><a href="#高可用集群" class="headerlink" title="高可用集群"></a>高可用集群</h2><p> <img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200330094023.png"  alt></p>
<ul>
<li>需要两台 nginx 服务器</li>
<li>需要 keepalived</li>
<li>需要虚拟 ip</li>
</ul>
<p><strong>克隆一份虚拟机</strong></p>
<p><a href="https://www.cnblogs.com/jinjiangongzuoshi/p/9313438.html" target="_blank" rel="noopener">https://www.cnblogs.com/jinjiangongzuoshi/p/9313438.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name centos --privileged&#x3D;true 470671670cac &#x2F;usr&#x2F;sbin&#x2F;init</span><br></pre></td></tr></table></figure>



<h1 id="nginx-原理"><a href="#nginx-原理" class="headerlink" title="nginx 原理"></a>nginx 原理</h1><p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200331144112.png"  alt></p>
<p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200331144151.png"  alt></p>
<p> <img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200331144627.png"  alt></p>
<blockquote>
<p>客户端发送 命令 到 master ，master 发送信号 给 worker（可以有多个worker），worker 接收到信号 争抢 资源，任务</p>
</blockquote>
<h2 id="一个master-和-多个-worker-的好处"><a href="#一个master-和-多个-worker-的好处" class="headerlink" title="一个master 和 多个 worker 的好处"></a>一个master 和 多个 worker 的好处</h2><ol>
<li><p>可以使用 nginx -s reload 热部署</p>
</li>
<li><p>每个 worker 都是独立的进程，所以不用加锁，节省了加锁带来的资源消耗</p>
<p>当 一个 worker 异常，还有其他的 worker 可以接收请求，不会造成服务中断</p>
</li>
</ol>
<h2 id="需要设置多少个worker"><a href="#需要设置多少个worker" class="headerlink" title="需要设置多少个worker"></a>需要设置多少个worker</h2><blockquote>
<p>Nginx同redis类似都采用了io多路复用机制，每个worker都是一个独立的进程，但每个进程里只有一个主线程，通过异步非阻塞的方式来处理请求，即使是千上万个请求也不在话下。每个worker的线程可以把一个cpu的性能发挥到极致所以worker数和服务器的cpu数相等是最为适宜的。设少了会浪费gpu，设多了会造成cpu频繁切换上下文带来的损耗</p>
</blockquote>
<h2 id="连接数-worker-connection"><a href="#连接数-worker-connection" class="headerlink" title="连接数 worker_connection"></a>连接数 worker_connection</h2><p>发送请求，一般占用 worker 2 或则 4 个 连接数</p>
<p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200331145854.png"  alt></p>
<p><img src="/" class="lazyload" data-src="/2020/03/28/Nginx/QQ%E5%9B%BE%E7%89%8720200331150856.png"  alt></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">惑</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://huohuohuohuohuohuo.github.io/2020/03/28/Nginx/">https://huohuohuohuohuohuo.github.io/2020/03/28/Nginx/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://huohuohuohuohuohuo.github.io" target="_blank">惑</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Nginx/">Nginx</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/huohuohuohuohuohuo/figurebed/cover/%E7%83%AD%E7%88%B1%E5%AD%A6%E4%B9%A07.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/03/31/SpringCloud/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/huohuohuohuohuohuo/figurebed/cover/%E7%83%AD%E7%88%B1%E5%AD%A6%E4%B9%A07.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">SpringCloud</div></div></a></div><div class="next-post pull_right"><a href="/2020/03/26/SpringBoot/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/huohuohuohuohuohuo/figurebed/cover/%E7%83%AD%E7%88%B1%E5%AD%A6%E4%B9%A03.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SpringBoot</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify: false,
  verify: true,
  appId: 'NUX37gQJU0r3YrAOapcyhb7C-gzGzoHsz',
  appKey: 'GHq929bhcc9xh2EF02O3NKx9',
  placeholder: 'Please leave your footprints',
  avatar: 'monsterid',
  meta: guest_info,
  pageSize: '10',
  lang: 'en',
  recordIP: false,
  serverURLs: ''
});</script></div></article></main><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/gh/huohuohuohuohuohuo/figurebed/cover/%E7%83%AD%E7%88%B1%E5%AD%A6%E4%B9%A04.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2020 By 惑</div><div class="framework-info"><span> </span><a href="https://huohuohuohuohuohuo.github.io/"><span>Welcome To MyBlog</span></a><span class="footer-separator">|</span><span> </span><a href="https://github.com/huohuohuohuohuohuo" target="_blank" rel="noopener"><span>( •̀ ω •́ )✧</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script>$(function () {
  $('span.katex-display').wrap('<div class="katex-wrap"></div>')
})</script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script id="ribbon_piao" mobile="true" src="/js/third-party/piao.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/search/local-search.js"></script><script>if (document.getElementsByClassName('mermaid').length) {
  loadScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js',function () {
    mermaid.initialize({
      theme: 'default',
  })
})
}</script></body></html>